#!/bin/bash

#Color codes abbreviations
RED='\033[0;31m'
NC='\033[0m' # No Color
GREEN='\033[0;32m'


#Check whether and array contains a string variable
function contains_string(){
    local to_find="$1"
    shift
    local arr=("$@")
    for i in "${arr[@]}"
    do
        if [ "$i" == "$to_find" ] ; then
            echo true
            return
        fi
    done
    echo false
    return
    }

#Read an answer from user
function read_answer(){
	while true; do
			read -p "$(echo -e "$1")" yn
		case $yn in
			[Yy]* ) answer=true; break;;
			[Nn]* ) answer=false; break;;
			* ) echo "Please answer yes or no.";;
		esac
	done
	echo $answer
}

function check_pymod(){
    if ! pip3 list | grep -F "$1" &> /dev/null

    then
        echo -e "${RED}ERROR: Python module $1 not found. \u2716${NC}\n"
        missing_reqs+=("$1")
    else
        echo -e "${GREEN}Found "$(pip3 list | grep -F "$1")" \u2714${NC}\n"
    fi
}

function check_cpplib(){
    templibname="$(whereis "lib$1.so")"
    IFS=' '
    read -a strarr <<< "$templibname"
    if [ "${#strarr[@]}" -le 1 ]
    then
        echo -e "${RED}ERROR: Library $1 not found. \u2716${NC}\n"
        missing_reqs+=("$1")
    else
        echo -e "${GREEN}Found "${strarr[${#strarr[@]} - 1]}" \u2714${NC}\n"
    fi
}

function check_command(){
    if ! command -v "$1" &> /dev/null
    then
        echo -e "${RED}ERROR: $1 not found. \u2716${NC}\n"
        missing_reqs+=("$1")
    else
        echo -e "${GREEN}Found $("$1" --version) \u2714${NC}\n"
    fi
}

#Check the application requirements
function check_all_reqs(){
    #Python3
    if ! command -v python3 &> /dev/null
    then
        if ! command -v python2 &> /dev/null
        then
            echo -e "${RED}ERROR: No python installed. \u2716${NC}\\nPlease install Python3"
        else
            python2_version=$(python2 -V 2>&1)
            echo -e "${RED}ERROR: Python3 not found. \u2716${NC}\nLatest version of python is $python2_version\nPlease install python3\n"
            unset python2_version
        fi
        missing_reqs+=("python3")
    else
        echo -e "${GREEN}Found $(python3 --version) \u2714${NC}\n"
        IFS=' '
        read -a strarr <<< "$(python3 --version)"
        IFS='.'
        read -a strarr <<< "${strarr[1]}"
        IFS=''
        python_version="${strarr[0]}.${strarr[1]}$version_append"
    fi

    #pip3
    check_command "pip3"

    #gcc
    check_command "gcc"

    #g++
    check_command "g++"

    #wget
    check_command "wget"

    #Nuitka
    check_pymod "Nuitka"

    #numpy
    check_pymod "numpy"

    #gmp
    check_cpplib "gmp"

    #ssl
    check_cpplib "ssl"

    #crypto
    check_cpplib "crypto"

    if $noroot
    then
        check_command "make"
        if [ $( contains_string "python3 ${missing_reqs[@]}" ) ]
        then
            check_cpplib "ffi"
            check_cpplib "zlib"
            check_cpplib "m4"
        fi
    fi
    }


new_path=false
install_missing=false
py_use_def="true"
noroot=false

if command -v yum > /dev/null
then
    version_append="m"
    py_use_def="false"
fi

#Scan the command line arguments
for i in "$@"; do
  case $i in
	-p=*|--prefix=*)
        inst_path="${i#*=}"
        inst_path="${inst_path/\~/$HOME}"
        new_path=true
        python_include="$inst_path/include"
        python_lib="$inst_path/lib"
        boost_include="$inst_path/include"
        boost_lib="$inst_path/lib"
		shift;;
	-i=*|--install-missing=*)
		install_missing="${i#*=}"
		shift;;
	-bi=*|--boost-include=*)
		boost_include="${i#*=}"
	    boost_include="${boost_include/\~/$HOME}"
		shift;;
	-bl=*|--boost-lib=*)
		boost_lib="${i#*=}"
	    boost_lib="${boost_lib/\~/$HOME}"
		shift;;
	-pi=*|--python-include=*)
		python_include="${i#*=}"
	    python_include="${python_include/\~/$HOME}"
		shift;;
	-bl=*|--boost-lib=*)
		python_lib="${i#*=}"
	    python_lib="${python_lib/\~/$HOME}"
		shift;;
	-nr|--noroot*)
        noroot=true
		shift;;
	-cn=|--core-number=*)
        core_number="${i#*=}"
		shift;;
	-*|--*)
	  echo -e "${RED}Unknown Argument: $i${NC}\n"
	  exit 1;;
	*)
	  ;;
  esac
done

if [ -z $inst_path ]
then
    inst_path="/usr/local/bin/"
fi
if [ -z $python_include ]
then
    python_include="/usr/include"
fi
if [ -z $python_lib ]
then
    if command -V yum
    then
        python_lib="/usr/lib64"
    else
        python_lib="/usr/lib"
    fi
fi
if [ -z $boost_include ]
then
    boost_include="/usr/local/include"
fi
if [ -z $boost_lib ]
then
    boost_lib="/usr/local/lib"
fi
if [ -z core_number ]
then
    core_number="$(nproc)/2" | bc
fi

echo -e "\nStarting the configuration of the Lammps Automator\n"
#Check all the requirements

echo -e "Checking all the requirements...\n"

declare -a missing_reqs=()
check_all_reqs



#Check that all of the requirements have been satisfied
if (( ${#missing_reqs[@]} > 0 ))
then
	echo -e "${RED}Some of the requirements have not been satisfied${NC}"
	echo -e "Missing requirements: ${missing_reqs[*]}\n"
	
	if ! $install_missing
	then
		if $( read_answer "Would you like to install the missing requirements?" )
		then
			install_missing=true
		fi
	fi
	if $install_missing
	then
        echo -e "Starting the requirements' installation tool\n"
        if $noroot
        then
            if [ $( contains_string "gcc" "${missing_reqs[@]}" ) ] || [ $( contains_string "wget" "${missing_reqs[@]}" ) ]
            then
                echo -e "${RED}ERROR: Cannoot install gcc/wget without root privileges.${NC}"
                exit 1
            fi
            if [ -f "install_noroot" ]
            then
                . ./install_noroot "${missing_reqs[@]}"
            elif [ -f "../install_noroot" ]
            then
                . ../install_noroot "${missing_reqs[@]}"
            else
                echo -e "${RED}ERROR: The requirement installation script has been moved.${NC} Please pull the repository again to acquire it.\n"
            exit
            fi
        else
            if [ -f "install_requirements" ]
            then
                sudo . ./install_requirements "${missing_reqs[@]}"
            elif [ -f "../install_requirements" ]
            then
                sudo . ../install_requirements "${missing_reqs[@]}"
            else
                echo -e "${RED}ERROR: The requirement installation script has been moved.${NC} Please pull the repository again to acquire it.\n"
            exit
            fi
        fi
	else
		exit
	fi
else
	echo -e "${GREEN}All of the requriments are satisfied. Starting to build the binary files.${NC}\n"
fi


declare -a missing_reqs=()
check_all_reqs
if [ -z "${missing_reqs[@]}" ]
then
    echo -e "${GREEN}All of the missing requirements have been satisfied\nStarting to build boost${NC}\n\n"
else
    echo -e "${RED}ERROR: Falied to install these requirements: ${missing_reqs[@]}. Please try to install them yourself.${NC}\n\n"
    exit
fi

#boost
pv=python_version
pv="${pv/m/}"
if [ -d "$boost_include/boost" ] && [ -f "$boost_lib/libboost_python"${pv/./}".so" ]
then
    echo -e "${GREEN}Boost has been correctly installed with python$pv \u2714${NC}\n"
else
    echo -e "${RED}ERROR: Incorrect boost installation \u2716${NC}\n"

	if ! $install_missing
	then
		if $( read_answer "Would you like to install boost?" )
		then
			install_missing=true
		fi
	fi
	if $install_missing
    then
        if [ -f "install_boost" ]
        then
            . ./install_boost
        else
            if [ -f "../install_boost" ]
            then
                . ../install_boost
            else
                echo -e "${RED}ERROR: The boost installation script has been moved.${NC} Please pull the repository again to acquire it.\n"
            fi
        fi
    else
        exit
    fi
fi

#Compile the shortener class into a python module
if [ -f "cpp_part/shortener.cpp" ] && [ -f "cpp_part/shortener.hpp" ] && [ -f "cpp_part/shrt_lib.cpp" ]
then
    make -C "cpp_part" PYTHON_VERSION="$python_version" PYTHON_INC="$python_include" PYTHON_LIB="$python_lib" BOOST_INC="$boost_include" BOOST_LIB="$boost_lib" PY_USE_DEF=$py_use_def
else
    if [ -f "../cpp_part/shortener.cpp" ] && [ -f "../cpp_part/shortener.hpp" ] && [ -f "../cpp_part/shrt_lib.cpp" ]
    then
        make -C "../cpp_part" PYTHON_VERSION="$python_version" PYTHON_INC="$python_include" PYTHON_LIB="$python_lib" BOOST_INC="$boost_include" BOOST_LIB="$boost_lib" PY_USE_DEF=$py_use_def
    else
        echo -e "${RED}ERROR: Some of the shortener files have been moved. Please perform a git pull to acquire them.${NC}"
        exit
    fi
fi



#Compile python files
if [ -f "python_part/lmp_auto.py" ] && [ -f "python_part/CONSTANTS.py" ] && [ -f "python_part/DataGenerator.py" ] && [ -f "python_part/DataModifier.py" ] && [ -f "python_part/helper_functions.py" ] && [ -f "python_part/Logger.py" ]
then
	python3 -m nuitka --follow-imports python_part/lmp_auto.py 
else
if [ -f "../python_part/lmp_auto.py" ] && [ -f "../python_part/CONSTANTS.py" ] && [ -f "../python_part/DataGenerator.py" ] && [ -f "../python_part/DataModifier.py" ] && [ -f "../python_part/helper_functions.py" ] && [ -f "../python_part/Logger.py" ]
	then
		python3 -m nuitka --follow-imports ../python_part/lmp_auto.py 
	else
		echo -e "${RED}ERROR: Configure file is run from an incorrect directory.${NC}\nPlease run configure file from the build or main project folder.\n"
        exit
	fi
fi

if [ -f "lmp_auto.bin" ]
then
	echo -e "${GREEN}The binary file has been successfully created.${NC}\n"

	if ! $new_path
	then
		echo -e "You have not specified an installation directory.\nThe binary will be installed in $inst_path\n"
	else
		echo -e "The installation directory: $inst_path\n"
	fi


	if [ -d "$inst_path" ]
	then
		echo -e "${GREEN}Installation directory exists.${NC}\n"	
	else
		if $( read_answer "$(echo -e "${RED}Installation directory $inst_path not found.${NC} Would you like to create one?")" )
		then
			sudo mkdir -p $inst_path
		else
			exit
		fi
	fi

	if [ -z $(echo $PATH | grep -E "(:|^)${inst_path%/}:") ]
	then
		if $( read_answer "$(echo -e "Directory $inst_path is not int the \$PATH. Would you like to add it?")" )
		then
			echo PATH=$PATH:$inst_path >> ~/.bashrc
		fi
	fi
	sudo cp lmp_auto.bin $inst_path/lmp_auto
	
	echo -e "${GREEN}Lammps Auto has been successfully installed!${NC}\n" 

else
	echo -e "${RED}Something went wrong wile creating a binary file.${NC}\nPlease check for Nuitka errors.\n"
fi








